<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request E-Pass - ResidentialHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div id="sidebarContainer"></div>

    <div class="main-content">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Request E-Pass</h1>
            <p class="text-gray-600 mt-1">Generate a gate pass for your guest or visitor</p>
        </div>

        <div class="max-w-2xl mx-auto">
            <div class="bg-white rounded-2xl shadow-lg p-8">

                <!-- Guest Name -->
                <div class="mb-5">
                    <label class="form-label">Guest Name <span class="text-red-500">*</span></label>
                    <input type="text" id="guestName" class="form-input" placeholder="Full name of your guest" required>
                </div>

                <!-- Contact -->
                <div class="mb-5">
                    <label class="form-label">Guest Contact <span class="text-red-500">*</span></label>
                    <input type="tel" id="contact" class="form-input" placeholder="10-digit mobile number" maxlength="10" required>
                </div>

                <!-- Purpose -->
                <div class="mb-5">
                    <label class="form-label">Purpose of Visit</label>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mt-2">
                        <label class="purpose-btn border-2 border-gray-200 rounded-xl p-4 text-center cursor-pointer hover:border-blue-400 transition" data-purpose="Personal Visit">
                            <input type="radio" name="purpose" value="Personal Visit" class="hidden">
                            <div class="text-2xl mb-1">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
                            <p class="text-sm font-semibold text-gray-700">Personal</p>
                        </label>
                        <label class="purpose-btn border-2 border-gray-200 rounded-xl p-4 text-center cursor-pointer hover:border-blue-400 transition" data-purpose="Business">
                            <input type="radio" name="purpose" value="Business" class="hidden">
                            <div class="text-2xl mb-1">ğŸ’¼</div>
                            <p class="text-sm font-semibold text-gray-700">Business</p>
                        </label>
                        <label class="purpose-btn border-2 border-gray-200 rounded-xl p-4 text-center cursor-pointer hover:border-blue-400 transition" data-purpose="Delivery">
                            <input type="radio" name="purpose" value="Delivery" class="hidden">
                            <div class="text-2xl mb-1">ğŸ“¦</div>
                            <p class="text-sm font-semibold text-gray-700">Delivery</p>
                        </label>
                        <label class="purpose-btn border-2 border-gray-200 rounded-xl p-4 text-center cursor-pointer hover:border-blue-400 transition" data-purpose="Service">
                            <input type="radio" name="purpose" value="Service" class="hidden">
                            <div class="text-2xl mb-1">ğŸ”§</div>
                            <p class="text-sm font-semibold text-gray-700">Service</p>
                        </label>
                        <label class="purpose-btn border-2 border-gray-200 rounded-xl p-4 text-center cursor-pointer hover:border-blue-400 transition" data-purpose="Event">
                            <input type="radio" name="purpose" value="Event" class="hidden">
                            <div class="text-2xl mb-1">ğŸ‰</div>
                            <p class="text-sm font-semibold text-gray-700">Event</p>
                        </label>
                        <label class="purpose-btn border-2 border-gray-200 rounded-xl p-4 text-center cursor-pointer hover:border-blue-400 transition" data-purpose="Other">
                            <input type="radio" name="purpose" value="Other" class="hidden">
                            <div class="text-2xl mb-1">ğŸ“</div>
                            <p class="text-sm font-semibold text-gray-700">Other</p>
                        </label>
                    </div>
                </div>

                <!-- Arrival & Departure row -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5 mb-5">
                    <div>
                        <label class="form-label">Expected Arrival</label>
                        <input type="text" id="arrival" class="form-input" placeholder="e.g., 01-Feb-2026, 10:00 AM">
                    </div>
                    <div>
                        <label class="form-label">Expected Departure</label>
                        <input type="text" id="departure" class="form-input" placeholder="e.g., 01-Feb-2026, 06:00 PM">
                    </div>
                </div>

                <!-- Vehicle Number -->
                <div class="mb-6">
                    <label class="form-label">Vehicle Number <span class="text-gray-400 font-normal">(optional)</span></label>
                    <input type="text" id="vehicleNo" class="form-input" placeholder="e.g., DL01AB1234">
                </div>

                <!-- Info box -->
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-xl flex items-start gap-3">
                    <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16v-6m0 0V5m0 5h-6m6 0h6m-6 6h6.586a1 1 0 01.707.293l2.414 2.414a1 1 0 01.293.707V19a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h4a2 2 0 012 2v1"></path>
                    </svg>
                    <div>
                        <p class="text-blue-800 text-sm font-semibold">How it works</p>
                        <p class="text-blue-700 text-sm mt-0.5">Once submitted, an admin will review your request. If approved, a QR code gate pass will be generated for your guest.</p>
                    </div>
                </div>

                <!-- Submit -->
                <button id="submitBtn" class="w-full btn-primary" onclick="submitEpass()">
                    Submit E-Pass Request
                </button>

                <!-- Back link -->
                <div class="text-center mt-4">
                    <a href="/user/support.html" class="text-gray-500 hover:text-gray-700 text-sm">â† Back to Tickets</a>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/auth.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/components/sidebar.js"></script>
    <script>
        auth.requireAuth(['USER']);
        document.getElementById('sidebarContainer').innerHTML = createUserSidebar('epass');

        // â”€â”€â”€ Purpose tile selection (same pattern as complaint categories) â”€
        document.querySelectorAll('.purpose-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.purpose-btn').forEach(b => b.classList.remove('border-blue-500', 'bg-blue-50'));
                btn.classList.add('border-blue-500', 'bg-blue-50');
                btn.querySelector('input').checked = true;
            });
        });

        // â”€â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function submitEpass() {
            const guestName = document.getElementById('guestName').value.trim();
            const contact   = document.getElementById('contact').value.trim();
            const purposeEl = document.querySelector('input[name="purpose"]:checked');
            const purpose   = purposeEl ? purposeEl.value : null;
            const arrival   = document.getElementById('arrival').value.trim() || 'Not Specified';
            const departure = document.getElementById('departure').value.trim() || 'Not Specified';
            const vehicleNo = document.getElementById('vehicleNo').value.trim() || null;

            // Validation
            if (!guestName) {
                showToast('Please enter the guest name', 'error');
                return;
            }
            if (!contact || contact.length !== 10 || !/^[0-9]+$/.test(contact)) {
                showToast('Please enter a valid 10-digit contact number', 'error');
                return;
            }

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = 'Submitting...';

            const result = await api.submitEpass({
                guest_name: guestName,
                contact:    contact,
                purpose:    purpose,
                arrival:    arrival,
                departure:  departure,
                vehicle_no: vehicleNo
            });

            if (result && result.success) {
                showToast(`E-Pass request submitted! Ticket #${result.ticket_id}`, 'success');
                setTimeout(() => { window.location.href = '/user/support.html'; }, 1500);
            } else {
                showToast(result?.message || 'Failed to submit request', 'error');
                btn.disabled = false;
                btn.textContent = 'Submit E-Pass Request';
            }
        }
    </script>
</body>
</html>