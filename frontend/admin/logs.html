<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Logs - ResidentialHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div id="sidebarContainer"></div>

    <div class="main-content">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Activity Logs</h1>
            <p class="text-gray-600 mt-1">Monitor all user activity across the community</p>
        </div>

        <!-- Search & Filters -->
        <div class="bg-white rounded-2xl shadow-lg p-5 mb-6">
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1 relative">
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <input type="text" id="searchInput" class="form-input pl-10" placeholder="Search by user, action, or description..." oninput="applyFilters()">
                </div>
                <select id="actionFilter" class="form-input w-full sm:w-52" onchange="applyFilters()">
                    <option value="all">All Actions</option>
                    <option value="LOGIN">Login</option>
                    <option value="LOGOUT">Logout</option>
                    <option value="COMPLAINT">Complaint</option>
                    <option value="EPASS">E-Pass</option>
                    <option value="PROFILE">Profile Update</option>
                    <option value="NOTICE">Notice</option>
                </select>
            </div>
        </div>

        <!-- Stats Row -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm p-4 text-center">
                <p class="text-2xl font-bold text-blue-600" id="totalLogs">â€”</p>
                <p class="text-xs text-gray-500 mt-1">Total Events</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 text-center">
                <p class="text-2xl font-bold text-green-600" id="loginCount">â€”</p>
                <p class="text-xs text-gray-500 mt-1">Logins</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 text-center">
                <p class="text-2xl font-bold text-orange-600" id="complaintCount">â€”</p>
                <p class="text-xs text-gray-500 mt-1">Complaints</p>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 text-center">
                <p class="text-2xl font-bold text-purple-600" id="epassCount">â€”</p>
                <p class="text-xs text-gray-500 mt-1">E-Passes</p>
            </div>
        </div>

        <!-- Timeline Log -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <div id="logsContainer">
                <div class="animate-pulse space-y-4">
                    <div class="flex gap-3"><div class="w-10 h-10 bg-gray-200 rounded-full flex-shrink-0"></div><div class="flex-1"><div class="h-3 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-3 bg-gray-200 rounded w-1/3"></div></div></div>
                    <div class="flex gap-3"><div class="w-10 h-10 bg-gray-200 rounded-full flex-shrink-0"></div><div class="flex-1"><div class="h-3 bg-gray-200 rounded w-2/3 mb-2"></div><div class="h-3 bg-gray-200 rounded w-1/4"></div></div></div>
                    <div class="flex gap-3"><div class="w-10 h-10 bg-gray-200 rounded-full flex-shrink-0"></div><div class="flex-1"><div class="h-3 bg-gray-200 rounded w-4/5 mb-2"></div><div class="h-3 bg-gray-200 rounded w-1/3"></div></div></div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/auth.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/components/admin-side-bar.js"></script>
    <script>
        auth.requireAuth(['ADMIN']);
        document.getElementById('sidebarContainer').innerHTML = createAdminSidebar('logs');

        let allLogs = [];

        const actionMeta = {
            LOGIN:       { icon: 'ðŸ”', bg: 'bg-blue-100',   text: 'text-blue-700',   label: 'Login' },
            LOGOUT:      { icon: 'ðŸšª', bg: 'bg-gray-100',   text: 'text-gray-700',   label: 'Logout' },
            COMPLAINT:   { icon: 'âš ï¸',  bg: 'bg-orange-100', text: 'text-orange-700', label: 'Complaint' },
            EPASS:       { icon: 'ðŸŽ«',  bg: 'bg-green-100',  text: 'text-green-700',  label: 'E-Pass' },
            PROFILE:     { icon: 'ðŸ‘¤', bg: 'bg-purple-100', text: 'text-purple-700', label: 'Profile' },
            NOTICE:      { icon: 'ðŸ“¢', bg: 'bg-blue-100',   text: 'text-blue-700',   label: 'Notice' }
        };

        // â”€â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadLogs() {
            const result = await api.getAdminDashboard();
            if (result && result.success && result.data && result.data.logs) {
                allLogs = result.data.logs;
                updateStats(allLogs);
                renderLogs(allLogs);
            } else {
                document.getElementById('logsContainer').innerHTML = getEmptyState('No logs available', 'ðŸ“');
            }
        }

        // â”€â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updateStats(logs) {
            document.getElementById('totalLogs').textContent     = logs.length;
            document.getElementById('loginCount').textContent    = logs.filter(l => (l.action||'').toUpperCase() === 'LOGIN').length;
            document.getElementById('complaintCount').textContent= logs.filter(l => (l.action||'').toUpperCase() === 'COMPLAINT').length;
            document.getElementById('epassCount').textContent    = logs.filter(l => (l.action||'').toUpperCase() === 'EPASS').length;
        }

        // â”€â”€â”€ Filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const action = document.getElementById('actionFilter').value;

            let filtered = allLogs;
            if (search) {
                filtered = filtered.filter(l =>
                    (l.user_id     || '').toLowerCase().includes(search) ||
                    (l.description || '').toLowerCase().includes(search) ||
                    (l.action      || '').toLowerCase().includes(search)
                );
            }
            if (action !== 'all') {
                filtered = filtered.filter(l => (l.action || '').toUpperCase() === action);
            }
            renderLogs(filtered);
        }

        // â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderLogs(logs) {
            const container = document.getElementById('logsContainer');
            if (logs.length === 0) {
                container.innerHTML = getEmptyState('No logs found', 'ðŸ“');
                return;
            }

            // Group by date
            const groups = {};
            logs.forEach(log => {
                const dateKey = log.timestamp
                    ? new Date(log.timestamp).toLocaleDateString('en-IN', { weekday:'long', day:'numeric', month:'long', year:'numeric' })
                    : 'Unknown Date';
                if (!groups[dateKey]) groups[dateKey] = [];
                groups[dateKey].push(log);
            });

            let html = '';
            Object.entries(groups).forEach(([date, entries]) => {
                html += `<div class="mb-6">
                    <p class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-3 pb-2 border-b border-gray-200">${date}</p>`;

                entries.forEach(log => {
                    const type = (log.action || 'OTHER').toUpperCase();
                    const meta = actionMeta[type] || { icon: 'â€¢', bg: 'bg-gray-100', text: 'text-gray-600', label: type };
                    html += `
                    <div class="flex gap-3 py-3 hover:bg-gray-50 rounded-lg px-2 transition fade-in">
                        <div class="w-10 h-10 ${meta.bg} rounded-full flex items-center justify-center flex-shrink-0 text-base">${meta.icon}</div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-sm font-semibold text-gray-800">${log.description || log.action || 'Activity'}</span>
                                <span class="px-2 py-0.5 ${meta.bg} ${meta.text} rounded-full text-xs font-semibold">${meta.label}</span>
                            </div>
                            <div class="flex items-center gap-3 mt-0.5">
                                <span class="text-xs text-gray-500">ðŸ‘¤ ${log.user_id || 'System'}</span>
                                ${log.timestamp ? `<span class="text-xs text-gray-400">${new Date(log.timestamp).toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit' })}</span>` : ''}
                            </div>
                        </div>
                    </div>`;
                });
                html += '</div>';
            });

            container.innerHTML = html;
        }

        loadLogs();
    </script>
</body>
</html>